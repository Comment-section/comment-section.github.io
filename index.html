<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comentarii</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://challenges.cloudflare.com; script-src 'self' 'unsafe-eval'; style-src 'self';">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <h1>Lasă un comentariu</h1>
  <form id="commentForm">
    <input type="text" id="name" placeholder="Nume (opțional)">
    <textarea id="message" placeholder="Mesajul tău" required></textarea>
    <div class="cf-turnstile" data-sitekey="0x4AAAAAAA9rgeB9x71eeXN6" data-auto-submit="true"></div>
    <button type="submit">Trimite</button>
  </form>

  <h2>Comentarii</h2>
  <div id="comments"></div>

  <script>
    const WORKER_URL = "https://comments-worker.opensourcenl.workers.dev/";

    async function loadComments() {
      try {
        const response = await fetch(WORKER_URL);
        if (!response.ok) {
          throw new Error("Failed to load comments");
        }
        const comments = await response.json();
        document.getElementById("comments").innerHTML = comments.map(c => `
          <div class="comment">
            <strong>${c.name}</strong>: ${c.message}
            <small>${new Date(c.timestamp).toLocaleString()}</small>
          </div>
        `).join("");
      } catch (error) {
        console.error("Eroare la încărcarea comentariilor:", error);
      }
    }

    document.getElementById("commentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = document.querySelector('.cf-turnstile-response') ? document.querySelector('.cf-turnstile-response').value : null;

      const formData = {
        name: document.getElementById("name").value || "Anonim",
        message: document.getElementById("message").value,
        token: token
      };

      try {
        const response = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }

        document.getElementById("message").value = "";
        loadComments();
      } catch (error) {
        console.error("Eroare la trimiterea comentariului:", error);
      }
    });

    loadComments();
  </script>
</body>
</html>
