<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comentarii</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://comments-worker.opensourcenl.workers.dev;">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <h1 class="mb-4">Lasă un comentariu</h1>
        <form id="commentForm">
            <div class="mb-3">
                <input type="text" id="name" class="form-control" placeholder="Nume (opțional)">
            </div>
            <div class="mb-3">
                <textarea id="message" class="form-control" placeholder="Mesajul tău" required></textarea>
            </div>
            <div class="mb-3">
                <label>
                    <input type="checkbox" id="terms" required> Sunt de acord cu termenii de utilizare
                </label>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Trimite</button>
        </form>

        <h2 class="mt-5">Comentarii</h2>
        <div id="comments"></div>
    </div>

    <script>
        const WORKER_URL = "https://comments-worker.opensourcenl.workers.dev/";

        async function loadComments() {
            try {
                const response = await fetch(WORKER_URL);
                if (!response.ok) {
                    throw new Error("Failed to load comments");
                }
                const comments = await response.json();
                document.getElementById("comments").innerHTML = comments.map(c => `
                    <div class="comment card p-3 mb-2">
                        <div class="card-body">
                            <h5 class="card-title">${c.name}</h5>
                            <p class="card-text">${c.message}</p>
                            <small class="text-muted">${new Date(c.timestamp).toLocaleString()}</small>
                        </div>
                    </div>
                `).join("");
            } catch (error) {
                console.error("Eroare la încărcarea comentariilor:", error);
            }
        }

        document.getElementById("commentForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById("name").value || "Anonim",
                message: document.getElementById("message").value
            };

            if (!document.getElementById("terms").checked) {
                alert("Trebuie să fii de acord cu termenii de utilizare.");
                return;
            }

            try {
                const response = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                document.getElementById("message").value = "";
                loadComments();
            } catch (error) {
                console.error("Eroare la trimiterea comentariului:", error);
            }
        });

        loadComments();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>
